# task05
Пятый таск

## API
**адрес: localhost:8000/**

#### POST /ads
Добавить новое объявление

**Пример запроса**
```sh
curl -X POST \
  http://localhost:8000/ads/ \
  -H 'Content-Type: application/json' \
  -d '{
        "name": "name",
        "date": "2021-08-30T19:17:25Z",
        "price": 10,
        "description": "description",
        "photos": [
            {
                "link": "link"
            },
            {
                "link": "link"
            },
            {
                "link": "link"
            }
        ]
    }'
```

#### GET /ads[?sort_by=value[&order=value]]
Получить список всех объявлений. Возможна сортировка по цене или дате.
Доступные sort_by значения: *price*, *date*
Доступные order значения: *asc* (по умолчанию), *dsc*

**Пример запроса**
```sh
curl -X GET \
  http://localhost:8000/ads/
```
```sh
curl -X GET \
  http://localhost:8000/ads/?sort_by=price
```
```sh
curl -X GET \
  http://localhost:8000/ads/?sort_by=date&order=dsc
```

#### GET /ads/<id>[?fields=value[&fields=value ...]]
Получить одно объявление. По умолчанию возвращает объявление без поля *description*, и только главной фотографией.
Доступные fields значения: *description*, *photos* (показать все фотографии)

**Пример запроса**
```sh
curl -X GET \
  http://localhost:8000/ads/1?fields=description&fields=photos
```
```sh
curl -X GET \
  http://localhost:8000/ads/2?fields=photos
```
```sh
curl -X GET \
  http://localhost:8000/ads/3
```

## Архитектура
- За основу проекта взят [golang-standards/project-layout](https://github.com/golang-standards/project-layout). Директории /cmd, /internal, /build соответствуют описанию в указанном проекте.
- Структура сервиса представлена 3-х уровневой архитектурой. **handler->service->repository**
- Настройка сервера, создание объектов для работы других пакетов - **server**
- Используемые модели - **model** 

## Описание
### Структура объявления
- ID
- Название объявления
- Дата создания
- Цена
- Ссылка на главное фото
- Ссылки на все фото - (опционально)
- Описание - (опционально)

### Методы
- Получение списка объявлений
- Получение одного объявления
- Создание объявления

### Известные недостатки
- К сожалению, у меня не получилось придумать sql-запрос так, чтобы я получал объявления и все фото сразу. Хотел сделать нормализованную бд, а в итоге сам себе усложнил жизнь.
- (а потом придумал, но не хватает уже времени на реализацию): 
```sql
SELECT ads.*, photos.* FROM ads LEFT JOIN ads_photos ON ads_photos.ad_id = ads.id INNER JOIN photos ON photos.id = ads_photos.photo_id;
```
- и построчная обработка.

### Примечания по коду (принятые решения)
- Исходя из деталей задания создаю структуру объявления.
- В качестве драйвера для работы с бд хотел взять [pq](github.com/lib/pq), но в статусе репозитория рекомендовали использовать [pgx](https://github.com/jackc/pgx).
- Два докер контейнера. Приложение работает в одном. База в другом. Вопрос - один Dockerfile или два? По сути можно было и один, используя multi-stage building и target. Но тогда при любой ошибке в докерфайле, даже если не при формировании image выбранного контейнера (а другого). Поэтому решил отделить докерфайлы. app в корне, pg (база данных) в папке db, вместе со скриптом инициализации.
- Я не знаю как правильно работать с nullable полями и json (см. model/ad.go - description). Почитал, что можно использовать gopkg.in/guregu/null.v4 , но почему-то тэг json:omitempty не работает. Поэтому просто использовал указатель на строку.


### Для запуска
- Linux (тестировал на Mint 20.0 x64);
- Билд приложения и запуск приложения:
```sh
make build
docker-compose up
```
- Билд и запуск приложения одной командой:
```sh
make start
```
- Запуск приложения одной командой:
```sh
make up
```
- Завершение работы приложения:
```sh
make down
```
- Очистка проекта (закрытие и удаление контейнеров, удаление исполняемых файлов):
```sh
make clean
```
- Полная очистка проекта (очистка проекта + удаление образов):
```sh
make cleanall
```